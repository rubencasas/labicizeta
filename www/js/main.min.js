function iniciar(){function calcularDistancia(lat1,lat2,lon1,lon2){var R=6371,dLat=(lat2-lat1).toRad(),dLon=(lon2-lon1).toRad(),lat1=lat1.toRad(),lat2=lat2.toRad(),a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.sin(dLon/2)*Math.sin(dLon/2)*Math.cos(lat1)*Math.cos(lat2),c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),d=R*c;return d}function iniciarCronometro(){cronometroIntervalo=setInterval(function(){tiempo.segundo++,tiempo.segundo>=60&&(tiempo.segundo=0,tiempo.minuto++),tiempo.minuto>=60&&(tiempo.minuto=0,tiempo.hora++),$(".hour").text(tiempo.hora<10?"0"+tiempo.hora:tiempo.hora),$(".minute").text(tiempo.minuto<10?"0"+tiempo.minuto:tiempo.minuto),$(".second").text(tiempo.segundo<10?"0"+tiempo.segundo:tiempo.segundo)},1e3)}function localizar(){var options={timeout:3e4,maximumAge:1e3,enableHighAccuracy:!0};watchID=navigator.geolocation.watchPosition(onSuccess,onError,options)}function localizarStop(){navigator.geolocation.clearWatch(watchID),console.log(coordenadas.html()),latitudNueva=0,longitudNueva=0}function onSuccess(position){coordenadas.html(coordenadas.html()+'{"lat":'+position.coords.latitude+',"lon":'+position.coords.longitude+',"alt":'+position.coords.altitude+',"acc":'+position.coords.accuracy+',"heading":'+position.coords.heading+',"speed":'+position.coords.speed+',"timestamp":'+position.timestamp+"},"),velocidad.text(position.coords.speed);var estasEnZamora=enZamora(position.coords.latitude,position.coords.longitude);estasEnZamora?(mensajes("Zamora"),latitudNueva&&(latitudVieja=latitudNueva),latitudNueva=position.coords.latitude,longitudNueva&&(longitudVieja=longitudNueva),longitudNueva=position.coords.longitude,latitudNueva&&latitudVieja&&(console.log("CALCULAR"),distanciaParcial=calcularDistancia(latitudVieja,latitudNueva,longitudVieja,longitudNueva),distanciaTotal+=Math.round(1e3*distanciaParcial)/1e3,console.log(distanciaParcial),CO2parcial=.15*distanciaTotal,CO2total+=Math.round(1e3*CO2parcial)/1e3),distancia.html(distanciaTotal),CO2.html(CO2total)):(mensajes("No estás dentro de Zamora"),parar())}function onError(error){alert("code: "+error.code+"\nmessage: "+error.message+"\n")}function guardarRuta(){var url="http://www.lasana.es/labicizeta/php/guardar-ruta.php",usuario=1;coordenadasTodas=coordenadas.html(),coordenadasTodas=coordenadasTodas.substr(0,coordenadas.length-1),$.ajax({url:url,type:"post",cache:!1,data:{datos:coordenadasTodas,user:usuario,distancia:distanciaTotal},dataType:"text",beforeSend:function(){mensajes("Enviando ruta...")},error:function(response){console.log("ERROR: "+response),mensajes("Ha habido un problema con la conexión, inténtalo de nuevo.")},success:function(response){console.log("respuesta: "+response),mensajes("Datos recibidos. ¡Gracias!"),resetRuta()}})}function enZamora(lati,longi){var latSur=41.487346,latNorte=41.52206,lonOeste=-5.800794,lonEste=-5.717501;return lati>=latSur&&latNorte>=lati&&lonEste>=longi&&longi>=lonOeste?!0:!1}function empezar(){console.log(textosBotones.empezar),$(".start-stop").text(textosBotones.parar),$(".bici-jpg").hide(),$(".bici-gif,.datos").show(),iniciarCronometro(),localizar(),$(".botones-ruta").hide(),cogiendoDatos=!0}function parar(){console.log("STOP"),$(".start-stop").text(textosBotones.empezar),$(".bici-gif").hide(),$(".bici-jpg").show(),clearInterval(cronometroIntervalo),localizarStop(),$(".botones-ruta").show(),cogiendoDatos=!1}function resetRuta(){distanciaParcial=0,distanciaTotal=0,CO2parcial=0,CO2total=0,latitudNueva=0,longitudNueva=0,$(".coordenadas-textarea").html(""),$(".hour").text("00"),$(".minute").text("00"),$(".second").text("00"),$(".botones-ruta").hide(),tiempo={hora:0,minuto:0,segundo:0},$(".datos").hide()}function modal(ok,cancel,pregunta){$(".modal p").text(pregunta),$(".modal").show(),okFuncion=function(){ok()},cancelFuncion=function(){cancel()}}function cerrarModal(){$(".modal").hide()}function mensajes(texto){$(".mensajes p").text(""),$(".mensajes p").text(texto)}var coordenadasTodas,latitudNueva,latitudVieja,longitudNueva,longitudVieja,distanciaParcial,CO2parcial,cronometroIntervalo,okFuncion,cancelFuncion,watchID=null,cogiendoDatos=!1,coordenadas=$(".coordenadas-textarea"),velocidad=$(".velocidad"),distancia=$(".distancia"),CO2=$(".CO2"),distanciaTotal=0,CO2total=0,tiempo={hora:0,minuto:0,segundo:0},textosBotones={empezar:"PEDALEAR",parar:"PARAR"};console.log("INICIADO"),$(".start-stop").text(textosBotones.empezar),"undefined"==typeof Number.prototype.toRad&&(Number.prototype.toRad=function(){return this*Math.PI/180}),$(".start-stop").on("click",function(){return cogiendoDatos?(parar(),!1):(empezar(),!1)}),$(".guardar-ruta").on("click",function(){return modal(guardarRuta,cerrarModal,"¿Seguro que quieres mandarnos los datos de tu ruta?"),!1}),$(".reset-ruta").on("click",function(){return modal(resetRuta,cerrarModal,"¿Seguro que quieres eliminar los datos de tu ruta?"),!1}),$(".modal .siOK").on("click",function(){return okFuncion(),cerrarModal(),!1}),$(".modal .noOK").on("click",function(){return cancelFuncion(),!1})}