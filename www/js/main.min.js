function mensajes(texto){$(".mensajes p").text(""),$(".mensajes p").text(texto)}function iniciar(){function consultarNombresEmailsPasswords(){var url="http://www.lasana.es/labicizeta/php/consulta-usuarios.php";$.ajax({url:url,type:"post",dataType:"json",beforeSend:function(){},error:function(response){console.log("ERROR: "+response),mensajes("Ha habido un problema con la conexión, inténtalo de nuevo.")},success:function(response){for(var i=0;i<response.length;i++){var obj=response[i];for(var key in obj)"id"===key&&ids.push(obj[key]),"nombre"===key&&nombres.push(obj[key]),"email"===key&&emails.push(obj[key]),"password"===key&&passwords.push(obj[key])}}})}function nombreExiste(){nombreExisteBoleano=!1;for(var i=0;i<nombres.length;i++)if(inputNombre.val().toUpperCase()===nombres[i].toUpperCase()){mensajes("Nombre ocupado"),nombreExisteBoleano=!0;break}console.log(nombreExisteBoleano)}function emailExiste(){emailExisteBoleano=!1;for(var i=0;i<emails.length;i++)if(inputEmail.val().toUpperCase()===emails[i].toUpperCase()){$(".usuario-crear").is(":visible")&&mensajes("Email existe"),emailExisteBoleano=!0;break}console.log(emailExisteBoleano)}function coincidenPass(){coincidenPassBoleano=!0,inputPass.val()!==inputPassRepetir.val()&&(mensajes("No coinciden las contraseñas"),coincidenPassBoleano=!1),console.log(coincidenPassBoleano)}function coincidenNombreEmailPassword(){var nombreExiste=$.inArray(inputNombre.val().toLowerCase(),nombres),emailExiste=$.inArray(inputNombre.val().toLowerCase(),emails);console.log(emailExiste),nombreExiste>=0&&passwords[nombreExiste]===inputPass.val()||emailExiste>=0&&passwords[emailExiste]===inputPass.val()?coincidenNombreEmailPasswordBoleano=!0:(mensajes("Usuario, email o contraseña no válidos"),coincidenNombreEmailPasswordBoleano=!1)}function isEmail(email){var regex=/^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;emailCorrectoBoleano=regex.test(email),console.log(email+regex.test(email)),emailCorrectoBoleano||mensajes("Email incorrecto")}function registrarUsuario(){var url="http://www.lasana.es/labicizeta/php/registrar-usuario.php";$.ajax({url:url,type:"post",cache:!1,data:{nombre:inputNombre.val().toLowerCase(),email:inputEmail.val().toLowerCase(),pass:inputPass.val()},dataType:"text",beforeSend:function(){mensajes("Registrando...")},error:function(response){console.log("ERROR: "+response),mensajes("Ha habido un problema con la conexión, inténtalo de nuevo.")},success:function(response){console.log("respuesta: "+response),mensajes(response)}})}function entrarUsuario(){var url="http://www.lasana.es/labicizeta/php/entrar-usuario.php";$.ajax({url:url,type:"post",cache:!1,data:{nombre:inputNombre.val().toLowerCase()},dataType:"text",beforeSend:function(){mensajes("Accediendo...")},error:function(response){console.log("ERROR: "+response),mensajes("Ha habido un problema con la conexión, inténtalo de nuevo.")},success:function(response){console.log("respuesta: "+response),mensajes(response),localStorageFunction(inputNombre.val().toLowerCase())}})}function localStorageFunction(usuario){var nombreExiste=$.inArray(usuario,nombres),emailExiste=$.inArray(usuario,emails);console.log("nombre"+nombreExiste),console.log("email"+emailExiste);var mostrarNombre=nombreExiste>=0?nombres[nombreExiste]:nombres[emailExiste],idCual=nombreExiste>=0?nombreExiste:emailExiste;console.log(ids[idCual]),localStorage.setItem("usuario",mostrarNombre),localStorage.setItem("identificador",ids[idCual]),comprobarlocalStorage()}function crearIntro(){mensajes(""),$(".seccion-usuario").show(),$(".seccion-usuario li, .seccion-usuario button").show(),$(".seccion-usuario li, .seccion-usuario button").not(".clase-crear").hide(),$(".seccion-usuario .nombre input").attr("placeholder","Nombre usuario"),$(".seccion-intro").hide()}function entrarIntro(){$(".seccion-usuario").show(),$(".seccion-usuario li, .seccion-usuario button").show(),$(".seccion-usuario li, .seccion-usuario button").not(".clase-entrar").hide(),$(".seccion-usuario .nombre input").attr("placeholder","Nombre usuario o email"),$(".seccion-intro").hide()}function recordarIntro(){$(".seccion-usuario").show(),$(".seccion-usuario li, .seccion-usuario button").show(),$(".seccion-usuario li, .seccion-usuario button").not(".clase-recordar").hide(),$(".seccion-intro").hide()}function atrasIntro(){$(".seccion-usuario").hide(),$(".seccion-intro").show()}function resetIntro(){mensajes(""),inputNombre.val(""),inputEmail.val(""),inputPass.val(""),inputPassRepetir.val("")}function comprobarlocalStorage(){localStorage.identificador?(localStorageBoleano=!0,console.log("LocalStorage SI"),mensajes("Bienvenido/a "+localStorage.getItem("usuario")),ventanaRutas()):(localStorageBoleano=!1,consultarNombresEmailsPasswords(),console.log("LocalStorage NO"))}function ventanaRutas(){$(".seccion-intro,.seccion-usuario").hide(),$(".seccion-ruta").show(),rutaSeccion()}function ventanaIntro(){resetIntro(),$(".seccion-intro").show(),$(".seccion-ruta").hide(),comprobarlocalStorage()}var localStorageBoleano,ids=[],nombres=[],emails=[],passwords=[],nombreExisteBoleano=!1,emailExisteBoleano=!1,coincidenPassBoleano=!0,emailCorrectoBoleano=!1,coincidenNombreEmailPasswordBoleano=!1,inputNombre=$(".seccion-usuario .nombre input"),inputEmail=$(".seccion-usuario .email input"),inputPass=$(".seccion-usuario .password input"),inputPassRepetir=$(".seccion-usuario .password-repetir input");comprobarlocalStorage(),inputNombre.on("focusout",function(){$(".usuario-crear").is(":visible")&&nombreExiste()}),inputEmail.on("focusout",function(){emailExiste()}),$(".intro-crear").on("click",function(){resetIntro(),crearIntro()}),$(".intro-entrar").on("click",function(){resetIntro(),entrarIntro()}),$(".intro-recordar").on("click",function(){resetIntro(),recordarIntro()}),$(".usuario-atras").on("click",function(){resetIntro(),atrasIntro()}),$(".usuario-salir").on("click",function(){localStorage.removeItem("identificador"),localStorage.removeItem("usuario"),ventanaIntro()}),$(".usuario-crear").on("click",function(){null==inputNombre.val()||""==inputNombre.val(),null==inputEmail.val()||""==inputEmail.val(),null==inputPass.val()||""==inputPass.val()?mensajes("Rellena todos los campos"):(mensajes(""),coincidenPass(),isEmail(inputEmail.val()),coincidenPassBoleano&&!nombreExisteBoleano&&!emailExisteBoleano&&emailCorrectoBoleano?(console.log("REGISTRAR"),registrarUsuario()):(nombreExiste(),emailExiste(),coincidenPass()))}),$(".usuario-entrar").on("click",function(){null==inputNombre.val()||""==inputNombre.val(),null==inputPass.val()||""==inputPass.val()?mensajes("Rellena todos los campos"):(mensajes(""),coincidenNombreEmailPassword(),coincidenNombreEmailPasswordBoleano&&(console.log("ENTRAR"),entrarUsuario()))}),$(".usuario-recordar").on("click",function(){null==inputEmail.val()||""==inputEmail.val()?mensajes("Introduce un email"):(mensajes(""),emailExisteBoleano?console.log("RECORDAR"):mensajes("No existe ningún usuario con ese email"))})}function rutaSeccion(){function calcularDistancia(lat1,lat2,lon1,lon2){var R=6371,dLat=(lat2-lat1).toRad(),dLon=(lon2-lon1).toRad(),lat1=lat1.toRad(),lat2=lat2.toRad(),a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.sin(dLon/2)*Math.sin(dLon/2)*Math.cos(lat1)*Math.cos(lat2),c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),d=R*c;return d}function iniciarCronometro(){cronometroIntervalo=setInterval(function(){tiempo.segundo++,tiempo.segundo>=60&&(tiempo.segundo=0,tiempo.minuto++),tiempo.minuto>=60&&(tiempo.minuto=0,tiempo.hora++),$(".hour").text(tiempo.hora<10?"0"+tiempo.hora:tiempo.hora),$(".minute").text(tiempo.minuto<10?"0"+tiempo.minuto:tiempo.minuto),$(".second").text(tiempo.segundo<10?"0"+tiempo.segundo:tiempo.segundo)},1e3)}function localizar(){var options={timeout:3e4,maximumAge:1e3,enableHighAccuracy:!0};watchID=navigator.geolocation.watchPosition(onSuccess,onError,options)}function localizarStop(){navigator.geolocation.clearWatch(watchID),console.log(coordenadas.html()),latitudNueva=0,longitudNueva=0}function onSuccess(position){coordenadas.html(coordenadas.html()+'{"lat":'+position.coords.latitude+',"lon":'+position.coords.longitude+',"alt":'+position.coords.altitude+',"acc":'+position.coords.accuracy+',"heading":'+position.coords.heading+',"speed":'+position.coords.speed+',"timestamp":'+position.timestamp+"},"),velocidad.text(position.coords.speed);var estasEnZamora=enZamora(position.coords.latitude,position.coords.longitude);estasEnZamora?(mensajes("Zamora"),latitudNueva&&(latitudVieja=latitudNueva),latitudNueva=position.coords.latitude,longitudNueva&&(longitudVieja=longitudNueva),longitudNueva=position.coords.longitude,latitudNueva&&latitudVieja&&(console.log("CALCULAR"),distanciaParcial=calcularDistancia(latitudVieja,latitudNueva,longitudVieja,longitudNueva),distanciaTotal+=Math.round(1e3*distanciaParcial)/1e3,console.log(distanciaParcial),CO2parcial=.15*distanciaTotal,CO2total+=Math.round(1e3*CO2parcial)/1e3),distancia.html(distanciaTotal),CO2.html(CO2total)):(mensajes("No estás dentro de Zamora"),parar())}function onError(error){alert("code: "+error.code+"\nmessage: "+error.message+"\n")}function guardarRuta(){var url="http://www.lasana.es/labicizeta/php/guardar-ruta.php",usuario=1;coordenadasTodas=coordenadas.html(),coordenadasTodas=coordenadasTodas.substr(0,coordenadas.length-1),$.ajax({url:url,type:"post",cache:!1,data:{datos:coordenadasTodas,user:usuario,distancia:distanciaTotal},dataType:"text",beforeSend:function(){mensajes("Enviando ruta...")},error:function(response){console.log("ERROR: "+response),mensajes("Ha habido un problema con la conexión, inténtalo de nuevo.")},success:function(response){console.log("respuesta: "+response),mensajes(response),resetRuta()}})}function enZamora(lati,longi){var latSur=41.487346,latNorte=41.52206,lonOeste=-5.800794,lonEste=-5.717501;return lati>=latSur&&latNorte>=lati&&lonEste>=longi&&longi>=lonOeste?!0:!1}function empezar(){console.log(textosBotones.empezar),$(".start-stop").text(textosBotones.parar),$(".bici-jpg").hide(),$(".bici-gif,.datos").show(),iniciarCronometro(),localizar(),$(".botones-ruta").hide(),cogiendoDatos=!0}function parar(){console.log("STOP"),$(".start-stop").text(textosBotones.empezar),$(".bici-gif").hide(),$(".bici-jpg").show(),clearInterval(cronometroIntervalo),localizarStop(),$(".botones-ruta").show(),cogiendoDatos=!1}function resetRuta(){distanciaParcial=0,distanciaTotal=0,CO2parcial=0,CO2total=0,latitudNueva=0,longitudNueva=0,$(".coordenadas-textarea").html(""),$(".hour").text("00"),$(".minute").text("00"),$(".second").text("00"),$(".botones-ruta").hide(),tiempo={hora:0,minuto:0,segundo:0},$(".datos").hide()}function modal(ok,cancel,pregunta){$(".modal p").text(pregunta),$(".modal").show(),okFuncion=function(){ok()},cancelFuncion=function(){cancel()}}function cerrarModal(){$(".modal").hide()}var coordenadasTodas,latitudNueva,latitudVieja,longitudNueva,longitudVieja,distanciaParcial,CO2parcial,cronometroIntervalo,okFuncion,cancelFuncion,watchID=null,cogiendoDatos=!1,coordenadas=$(".coordenadas-textarea"),velocidad=$(".velocidad"),distancia=$(".distancia"),CO2=$(".CO2"),distanciaTotal=0,CO2total=0,tiempo={hora:0,minuto:0,segundo:0},textosBotones={empezar:"PEDALEAR",parar:"PARAR"};console.log("INICIADO id="+localStorage.getItem("identificador")),$(".start-stop").text(textosBotones.empezar),"undefined"==typeof Number.prototype.toRad&&(Number.prototype.toRad=function(){return this*Math.PI/180}),$(".start-stop").on("click",function(){return cogiendoDatos?(parar(),!1):(empezar(),!1)}),$(".guardar-ruta").on("click",function(){return modal(guardarRuta,cerrarModal,"¿Seguro que quieres mandarnos los datos de tu ruta?"),!1}),$(".reset-ruta").on("click",function(){return modal(resetRuta,cerrarModal,"¿Seguro que quieres eliminar los datos de tu ruta?"),!1}),$(".modal .siOK").on("click",function(){return okFuncion(),cerrarModal(),!1}),$(".modal .noOK").on("click",function(){return cancelFuncion(),!1})}